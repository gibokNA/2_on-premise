name: WMS App CI/CD

# 1. 트리거: main 브랜치에 push가 발생하면 실행
on:
  push:
    branches: [ "main" ]
    paths:
      - 'app/**'           # 앱 코드가 바뀌거나
      - 'k8s/wms-app/**'   # 매니페스트가 바뀔 때만 실행

env:
  IMAGE_NAME: na3351/wms-app 

jobs:
  # JOB 1: 빌드 및 푸시 (CI) 
  # GitHub 클라우드 서버(ubuntu-latest)에서 실행
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and Push Docker Image
      uses: docker/build-push-action@v4
      with:
        context: ./app
        push: true
        # 이미지 태그를 Git 커밋 해시(sha)의 앞 7자리로 설정 (버전 관리)
        tags: ${{ env.IMAGE_NAME }}:${{ github.sha }}
        
  # JOB 2: 배포 (CD) 
  # Bastion 서버(self-hosted)에서 실행
  deploy:
    needs: build-and-push  # 빌드가 성공해야 배포 실행
    runs-on: self-hosted   # Bastion에 깔린 Runner가 이 작업을 가져감
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Update Kubernetes Manifest
      # app.yaml 파일 안의 이미지 태그(:v1 등)를 방금 빌드한 버전(github.sha)으로 교체
      run: |
        cd k8s/wms-app
        sed -i "s|image: .*|image: ${{ env.IMAGE_NAME }}:${{ github.sha }}|g" app.yaml
        cat app.yaml | grep image:  # 변경된 내용 확인용 출력

    - name: Deploy to Kubernetes
      # Bastion에 설정해둔 kubectl을 사용하여 적용
      run: |
        kubectl apply -f k8s/wms-app/
        
    - name: Check Rollout Status
      run: |
        kubectl rollout status deployment/wms-app